#include "GameUtil.h"
#include "BonusInvulnerability.h"
#include "Animation.h"
#include "AnimationManager.h"
#include "BoundingShape.h"
#include "BoundingSphere.h"
#include "Spaceship.h"

BonusInvulnerability::BonusInvulnerability(void)
    : GameObject("BonusInvulnerability")
{
    // Set random movement
    mAngle = rand() % 360;
    mRotation = 0;
    mPosition.x = rand() / 2;
    mPosition.y = rand() / 2;
    mPosition.z = 0.0;
    mVelocity.x = 5.0f * cos(DEG2RAD * mAngle);
    mVelocity.y = 5.0f * sin(DEG2RAD * mAngle);
    mVelocity.z = 0.0;

    

    // Set animation sprite
    Animation* anim = AnimationManager::GetInstance().GetAnimationByName("bonus_invuln");
    if (anim)
    {
        shared_ptr<Sprite> sprite = make_shared<Sprite>(anim->GetWidth(), anim->GetHeight(), anim);
        sprite->SetLoopAnimation(true);
        SetSprite(sprite);
        SetScale(0.1f);
    }
}

BonusInvulnerability::~BonusInvulnerability(void)
{
}

bool BonusInvulnerability::CollisionTest(shared_ptr<GameObject> o)
{
    if (GetType() == o->GetType()) return false;
    if (!mBoundingShape || !o->GetBoundingShape()) return false;
    return mBoundingShape->CollisionTest(o->GetBoundingShape());
}
void BonusInvulnerability::OnCollision(const GameObjectList& objects)
{
    for (auto obj : objects)
    {
        if (obj->GetType() == GameObjectType("Spaceship"))
        {
            dynamic_pointer_cast<Spaceship>(obj)->SetInvulnerable(10.0f); // 5 seconds
            mWorld->FlagForRemoval(GetThisPtr());
            break;
        }
    }
}
